{% extends "base.html" %}
{% block title %}Upload Room ‚Äì Gruha Alankara{% endblock %}

{% block content %}
<div class="upload-container">
    <!-- Step Indicator -->
    <div class="fade-in" style="margin-bottom:2.5rem;">
        <div
            style="display:inline-flex;align-items:center;gap:0.5rem;background:rgba(124,58,237,0.1);
            border:1px solid rgba(124,58,237,0.25);border-radius:50px;padding:0.3rem 1rem;
            font-size:0.78rem;color:var(--accent-light);margin-bottom:1.25rem;letter-spacing:0.05em;display:flex;justify-content:center;">
            üì∏ &nbsp; Room Image Upload
        </div>
        <h1 class="text-center mb-1">Set Up Your <span class="gradient-text">3D Room</span></h1>
        <p class="text-center text-muted mb-2" style="max-width:560px;margin-left:auto;margin-right:auto;">
            Upload photos of each wall (and ceiling/floor) to build a full 3D room.
            <strong style="color:var(--accent-light);">Front wall is required</strong>; others are optional.
        </p>
        <!-- Steps -->
        <div style="display:flex;align-items:center;justify-content:center;gap:0;margin-top:1.5rem;">
            <div style="display:flex;flex-direction:column;align-items:center;gap:0.35rem;">
                <div style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--highlight));
                    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.9rem;
                    box-shadow:0 0 16px var(--accent-glow);">1</div>
                <span
                    style="font-size:0.7rem;color:var(--accent-light);text-transform:uppercase;letter-spacing:0.07em;white-space:nowrap;">Upload</span>
            </div>
            <div
                style="flex:1;height:2px;background:linear-gradient(90deg,var(--accent),var(--highlight));opacity:0.35;min-width:50px;margin:0 0.75rem;margin-bottom:1.2rem;">
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;gap:0.35rem;">
                <div
                    style="width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,0.06);
                    border:2px solid rgba(255,255,255,0.1);
                    display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-weight:700;font-size:0.9rem;">
                    2</div>
                <span
                    style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.07em;white-space:nowrap;">AI
                    Analysis</span>
            </div>
            <div
                style="flex:1;height:2px;background:rgba(255,255,255,0.07);min-width:50px;margin:0 0.75rem;margin-bottom:1.2rem;">
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;gap:0.35rem;">
                <div
                    style="width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,0.06);
                    border:2px solid rgba(255,255,255,0.1);
                    display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-weight:700;font-size:0.9rem;">
                    3</div>
                <span
                    style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.07em;white-space:nowrap;">3D
                    Studio</span>
            </div>
        </div>
    </div>

    <form method="POST" action="{{ url_for('designs.upload') }}" enctype="multipart/form-data" id="uploadForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- 6-Face Upload Grid -->
        <div class="glass-card fade-in fade-in-delay-1" style="padding:1.5rem; border-color:rgba(124,58,237,0.2);">
            <h3 style="margin-bottom:0.4rem;font-family:var(--font-display);">üè† Room Faces</h3>
            <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:1.2rem;">Click any slot or drag &amp; drop
                an image onto it</p>
            <div class="faces-grid">

                <!-- Face: Front Wall (required) -->
                <div class="face-slot" id="slot_front">
                    <div class="face-label">
                        <span class="face-icon">üîµ</span> Front Wall <span class="required-badge">Required</span>
                    </div>
                    <div class="face-zone" id="zone_front" data-face="front" data-field="face_front">
                        <div class="face-preview-wrap" id="preview_front" style="display:none;">
                            <img id="previewImg_front" src="" alt="Front Wall Preview">
                            <button type="button" class="remove-face-btn" data-face="front">‚úï</button>
                        </div>
                        <div class="face-placeholder" id="placeholder_front">
                            <span style="font-size:2rem;">üñºÔ∏è</span>
                            <p>Click or drag image</p>
                        </div>
                        <input type="file" name="face_front" id="input_front" accept=".jpg,.jpeg,.png"
                            style="display:none;" required>
                    </div>
                </div>

                <!-- Face: Back Wall -->
                <div class="face-slot" id="slot_back">
                    <div class="face-label">
                        <span class="face-icon">üü£</span> Back Wall <span class="optional-badge">Optional</span>
                    </div>
                    <div class="face-zone" id="zone_back" data-face="back" data-field="face_back">
                        <div class="face-preview-wrap" id="preview_back" style="display:none;">
                            <img id="previewImg_back" src="" alt="Back Wall Preview">
                            <button type="button" class="remove-face-btn" data-face="back">‚úï</button>
                        </div>
                        <div class="face-placeholder" id="placeholder_back">
                            <span style="font-size:2rem;">üñºÔ∏è</span>
                            <p>Click or drag image</p>
                        </div>
                        <input type="file" name="face_back" id="input_back" accept=".jpg,.jpeg,.png"
                            style="display:none;">
                    </div>
                </div>

                <!-- Face: Left Wall -->
                <div class="face-slot" id="slot_left">
                    <div class="face-label">
                        <span class="face-icon">üü¢</span> Left Wall <span class="optional-badge">Optional</span>
                    </div>
                    <div class="face-zone" id="zone_left" data-face="left" data-field="face_left">
                        <div class="face-preview-wrap" id="preview_left" style="display:none;">
                            <img id="previewImg_left" src="" alt="Left Wall Preview">
                            <button type="button" class="remove-face-btn" data-face="left">‚úï</button>
                        </div>
                        <div class="face-placeholder" id="placeholder_left">
                            <span style="font-size:2rem;">üñºÔ∏è</span>
                            <p>Click or drag image</p>
                        </div>
                        <input type="file" name="face_left" id="input_left" accept=".jpg,.jpeg,.png"
                            style="display:none;">
                    </div>
                </div>

                <!-- Face: Right Wall -->
                <div class="face-slot" id="slot_right">
                    <div class="face-label">
                        <span class="face-icon">üü°</span> Right Wall <span class="optional-badge">Optional</span>
                    </div>
                    <div class="face-zone" id="zone_right" data-face="right" data-field="face_right">
                        <div class="face-preview-wrap" id="preview_right" style="display:none;">
                            <img id="previewImg_right" src="" alt="Right Wall Preview">
                            <button type="button" class="remove-face-btn" data-face="right">‚úï</button>
                        </div>
                        <div class="face-placeholder" id="placeholder_right">
                            <span style="font-size:2rem;">üñºÔ∏è</span>
                            <p>Click or drag image</p>
                        </div>
                        <input type="file" name="face_right" id="input_right" accept=".jpg,.jpeg,.png"
                            style="display:none;">
                    </div>
                </div>

                <!-- Face: Ceiling -->
                <div class="face-slot" id="slot_ceiling">
                    <div class="face-label">
                        <span class="face-icon">‚¨ú</span> Ceiling <span class="optional-badge">Optional</span>
                    </div>
                    <div class="face-zone" id="zone_ceiling" data-face="ceiling" data-field="face_ceiling">
                        <div class="face-preview-wrap" id="preview_ceiling" style="display:none;">
                            <img id="previewImg_ceiling" src="" alt="Ceiling Preview">
                            <button type="button" class="remove-face-btn" data-face="ceiling">‚úï</button>
                        </div>
                        <div class="face-placeholder" id="placeholder_ceiling">
                            <span style="font-size:2rem;">üñºÔ∏è</span>
                            <p>Click or drag image</p>
                        </div>
                        <input type="file" name="face_ceiling" id="input_ceiling" accept=".jpg,.jpeg,.png"
                            style="display:none;">
                    </div>
                </div>

                <!-- Face: Floor -->
                <div class="face-slot" id="slot_floor">
                    <div class="face-label">
                        <span class="face-icon">üü§</span> Floor <span class="optional-badge">Optional</span>
                    </div>
                    <div class="face-zone" id="zone_floor" data-face="floor" data-field="face_floor">
                        <div class="face-preview-wrap" id="preview_floor" style="display:none;">
                            <img id="previewImg_floor" src="" alt="Floor Preview">
                            <button type="button" class="remove-face-btn" data-face="floor">‚úï</button>
                        </div>
                        <div class="face-placeholder" id="placeholder_floor">
                            <span style="font-size:2rem;">üñºÔ∏è</span>
                            <p>Click or drag image</p>
                        </div>
                        <input type="file" name="face_floor" id="input_floor" accept=".jpg,.jpeg,.png"
                            style="display:none;">
                    </div>
                </div>

            </div><!-- .faces-grid -->
        </div>

        <!-- Room Type & Style Selectors -->
        <div class="upload-options fade-in fade-in-delay-2 mt-2">
            <div class="glass-card">
                <div class="form-group" style="margin-bottom:0;">
                    <label for="roomType">üè† Room Type</label>
                    <select name="room_type" id="roomType" class="form-control">
                        <option value="living_room">Living Room</option>
                        <option value="bedroom">Bedroom</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="dining_room">Dining Room</option>
                        <option value="office">Office / Study</option>
                        <option value="bathroom">Bathroom</option>
                    </select>
                </div>
            </div>

            <div class="glass-card">
                <div class="form-group" style="margin-bottom:0;">
                    <label for="styleSelect">üé® Design Style</label>
                    <select name="style" id="styleSelect" class="form-control">
                        <option value="modern">üè¢ Modern</option>
                        <option value="minimalist">ü™∑ Minimalist</option>
                        <option value="traditional">üèõÔ∏è Traditional</option>
                        <option value="industrial">üè≠ Industrial</option>
                        <option value="scandinavian">üá∏üá™ Scandinavian</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="text-center mt-2 fade-in fade-in-delay-3">
            <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn" style="min-width: 300px;">
                ü§ñ Analyze & Open Studio
            </button>
        </div>
    </form>
</div>

<style>
    .faces-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    @media (max-width: 768px) {
        .faces-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .faces-grid {
            grid-template-columns: 1fr;
        }
    }

    .face-slot {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .face-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .face-icon {
        font-size: 0.9rem;
    }

    .required-badge {
        font-size: 0.7rem;
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        padding: 0.1rem 0.4rem;
        border-radius: 20px;
        font-weight: 600;
    }

    .optional-badge {
        font-size: 0.7rem;
        background: rgba(100, 116, 139, 0.2);
        color: #94a3b8;
        padding: 0.1rem 0.4rem;
        border-radius: 20px;
    }

    .face-zone {
        border: 2px dashed rgba(124, 58, 237, 0.3);
        border-radius: 12px;
        min-height: 110px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.25s ease;
        overflow: hidden;
        position: relative;
        background: rgba(124, 58, 237, 0.03);
    }

    .face-zone:hover {
        border-color: var(--accent);
        background: rgba(124, 58, 237, 0.08);
        box-shadow: 0 0 16px var(--accent-glow);
    }

    .face-zone.has-image {
        border-style: solid;
        border-color: var(--primary);
    }

    .face-zone.drag-over {
        border-color: var(--highlight);
        background: rgba(6, 182, 212, 0.05);
    }

    .face-placeholder {
        text-align: center;
        color: var(--text-muted);
        pointer-events: none;
        padding: 0.5rem;
    }

    .face-placeholder p {
        font-size: 0.75rem;
        margin: 0.25rem 0 0;
    }

    .face-preview-wrap {
        width: 100%;
        height: 100%;
        min-height: 100px;
        position: relative;
    }

    .face-preview-wrap img {
        width: 100%;
        height: 100%;
        min-height: 100px;
        object-fit: cover;
        border-radius: 10px;
    }

    .remove-face-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        font-size: 0.7rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        padding: 0;
    }

    .remove-face-btn:hover {
        background: #ef4444;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    (function () {
        const FACES = ['front', 'back', 'left', 'right', 'ceiling', 'floor'];
        const FACE_LABELS = {
            front: 'Front Wall', back: 'Back Wall', left: 'Left Wall',
            right: 'Right Wall', ceiling: 'Ceiling', floor: 'Floor'
        };

        let cameraStream = null;
        let cameraTargetFace = null;

        FACES.forEach(face => {
            const zone = document.getElementById('zone_' + face);
            const input = document.getElementById('input_' + face);
            const preview = document.getElementById('preview_' + face);
            const placeholder = document.getElementById('placeholder_' + face);
            const previewImg = document.getElementById('previewImg_' + face);

            // Click to open file picker
            zone.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-face-btn')) return;
                input.click();
            });

            // File input change
            input.addEventListener('change', () => {
                if (input.files && input.files[0]) {
                    showFacePreview(face, input.files[0]);
                }
            });

            // Drag & Drop
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length && files[0].type.match(/^image\//)) {
                    // Assign to this face's input
                    const dt = new DataTransfer();
                    dt.items.add(files[0]);
                    input.files = dt.files;
                    showFacePreview(face, files[0]);
                }
            });

            // Remove button
            zone.querySelector('.remove-face-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                clearFacePreview(face);
            });
        });

        function showFacePreview(face, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg_' + face).src = e.target.result;
                document.getElementById('preview_' + face).style.display = 'block';
                document.getElementById('placeholder_' + face).style.display = 'none';
                document.getElementById('zone_' + face).classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function clearFacePreview(face) {
            document.getElementById('previewImg_' + face).src = '';
            document.getElementById('preview_' + face).style.display = 'none';
            document.getElementById('placeholder_' + face).style.display = 'flex';
            document.getElementById('zone_' + face).classList.remove('has-image');
            // Reset file input
            const inp = document.getElementById('input_' + face);
            inp.value = '';
        }

        // Camera
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('cameraCanvas');
        const captureBtn = document.getElementById('captureBtn');
        const closeCameraBtn = document.getElementById('closeCameraBtn');
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraForFaceEl = document.getElementById('cameraForFace');

        function openCamera(face) {
            cameraTargetFace = face;
            cameraForFaceEl.textContent = FACE_LABELS[face];
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    cameraStream = stream;
                    video.srcObject = stream;
                    cameraContainer.style.display = 'block';
                    cameraContainer.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(err => alert('Camera access denied: ' + err.message));
        }

        function closeCamera() {
            if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
            cameraContainer.style.display = 'none';
            cameraTargetFace = null;
        }

        captureBtn.addEventListener('click', () => {
            if (!cameraTargetFace) return;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            canvas.toBlob(blob => {
                const file = new File([blob], 'camera_' + cameraTargetFace + '.jpg', { type: 'image/jpeg' });
                const dt = new DataTransfer();
                dt.items.add(file);
                document.getElementById('input_' + cameraTargetFace).files = dt.files;
                showFacePreview(cameraTargetFace, file);
                closeCamera();
            }, 'image/jpeg', 0.9);
        });

        closeCameraBtn.addEventListener('click', closeCamera);

        // Form submit
        document.getElementById('uploadForm').addEventListener('submit', function () {
            const btn = document.getElementById('analyzeBtn');
            btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0;display:inline-block;vertical-align:middle;"></div> Analyzing...';
            btn.disabled = true;
        });
    })();
</script>
{% endblock %}