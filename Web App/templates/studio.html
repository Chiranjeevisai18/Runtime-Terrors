{% extends "base.html" %}
{% block title %}3D Studio ‚Äì Gruha Alankara{% endblock %}

{% block extra_head %}
<!-- Three.js and controls loaded from CDN -->
<script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
    }
}
</script>
<style>
    /* Studio-specific overrides */
    .footer {
        display: none;
    }

    .main-content {
        padding-top: 60px;
        min-height: calc(100vh - 60px);
    }

    /* ===== Sidebar ===== */
    .studio-sidebar {
        background: rgba(5, 5, 5, 0.95) !important;
        border-right: 1px solid rgba(255, 255, 255, 0.06) !important;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
    }

    .sidebar-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1.2rem;
        transition: border-color 0.3s ease;
    }

    .sidebar-section:hover {
        border-color: rgba(255, 255, 255, 0.1);
    }

    .sidebar-section h3 {
        font-size: 0.85rem !important;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #999 !important;
        font-weight: 700;
        margin-bottom: 1rem !important;
    }

    /* ===== AI Result Items ===== */
    .ai-result-item {
        padding: 0.6rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .ai-result-item:last-child {
        border-bottom: none;
    }

    .result-label {
        font-size: 0.65rem !important;
        color: #555 !important;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-weight: 700;
    }

    .result-value {
        color: #ccc !important;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .result-icon {
        font-size: 1.2rem !important;
        opacity: 0.7;
    }

    /* ===== Furniture List ===== */
    .furniture-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-height: 380px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.08) transparent;
    }

    .furniture-list::-webkit-scrollbar {
        width: 4px;
    }

    .furniture-list::-webkit-scrollbar-track {
        background: transparent;
    }

    .furniture-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }

    .furniture-item {
        display: flex;
        gap: 0.8rem;
        align-items: flex-start;
        padding: 0.8rem !important;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.04) !important;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.25s ease !important;
    }

    .furniture-item:hover {
        background: rgba(255, 255, 255, 0.06) !important;
        border-color: rgba(255, 255, 255, 0.12) !important;
        transform: translateX(3px) !important;
    }

    .furniture-preview {
        width: 42px !important;
        height: 42px !important;
        min-width: 42px;
        border-radius: 8px !important;
        font-size: 1.3rem !important;
        background: rgba(255, 255, 255, 0.04) !important;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .furniture-name {
        font-size: 0.88rem !important;
        font-weight: 700 !important;
        color: #d0d0d0 !important;
    }

    .furniture-desc {
        font-size: 0.73rem !important;
        color: #666 !important;
    }

    /* ===== Object Controls ===== */
    .selected-info {
        padding: 0.8rem;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        transition: opacity 0.3s;
    }

    .selected-info h4 {
        font-size: 0.9rem;
        font-weight: 700;
        color: #bbb;
        margin-bottom: 0.2rem;
    }

    .studio-controls {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
    }

    .studio-controls .btn {
        flex: 1;
        min-width: 0;
        font-size: 0.75rem !important;
        padding: 0.45rem 0.6rem !important;
        border-radius: 6px !important;
        background: rgba(255, 255, 255, 0.03) !important;
        border: 1px solid rgba(255, 255, 255, 0.08) !important;
        color: #aaa !important;
        font-weight: 600;
    }

    .studio-controls .btn:hover {
        background: rgba(255, 255, 255, 0.08) !important;
        border-color: rgba(255, 255, 255, 0.2) !important;
        color: #fff !important;
    }

    .btn-danger {
        border-color: rgba(239, 68, 68, 0.3) !important;
        color: #f87171 !important;
    }

    .btn-danger:hover {
        background: rgba(239, 68, 68, 0.12) !important;
        border-color: rgba(239, 68, 68, 0.5) !important;
    }

    /* ===== Canvas Toolbar ===== */
    .studio-toolbar {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
    }

    .studio-toolbar .btn {
        padding: 0.4rem 0.7rem !important;
        font-size: 1rem !important;
        border: none !important;
        background: transparent !important;
        border-radius: 6px !important;
    }

    .studio-toolbar .btn:hover {
        background: rgba(255, 255, 255, 0.1) !important;
    }

    /* ===== Spinner ===== */
    .spinner {
        width: 24px;
        height: 24px;
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-top-color: #888;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 2rem auto;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="studio-container">
    <!-- ============ Sidebar ============ -->
    <aside class="studio-sidebar" id="studioSidebar">
        <!-- AI Analysis Results -->
        <div class="sidebar-section">
            <h3>ü§ñ AI Analysis</h3>
            <div class="ai-results">
                <div class="ai-result-item">
                    <span class="result-icon">üè†</span>
                    <div>
                        <div class="result-label">Room Type</div>
                        <div class="result-value">{{ ai_output.get('room_type', 'Unknown') | replace('_', ' ') | title
                            }}</div>
                    </div>
                </div>
                <div class="ai-result-item">
                    <span class="result-icon">üé®</span>
                    <div>
                        <div class="result-label">Style</div>
                        <div class="result-value">{{ ai_output.get('suggested_style', design.style) | title }}</div>
                    </div>
                </div>
                {% if ai_output.get('caption') %}
                <div class="ai-result-item">
                    <span class="result-icon">üìù</span>
                    <div>
                        <div class="result-label">AI Caption</div>
                        <div class="result-value" style="font-size:0.85rem;">{{ ai_output.get('caption') }}</div>
                    </div>
                </div>
                {% endif %}
                {% if ai_output.get('detected_objects') %}
                <div class="ai-result-item">
                    <span class="result-icon">üëÅÔ∏è</span>
                    <div>
                        <div class="result-value" style="font-size:0.85rem;">
                            {{ ai_output.get('detected_objects', []) | join(', ') or 'None detected' }}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if ai_output.get('holistic_view') %}
                <div class="ai-result-item"
                    style="display:block; background:rgba(124,58,237,0.05); border:1px solid rgba(124,58,237,0.1); border-radius:10px; padding:0.8rem; margin-top:0.5rem;">
                    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.4rem;">
                        <span class="result-icon">üåê</span>
                        <div class="result-label"
                            style="text-transform:uppercase; letter-spacing:0.05em; font-weight:800; color:var(--highlight); font-size:0.75rem;">
                            Holistic Room Plan</div>
                    </div>
                    <div class="result-value"
                        style="font-size:0.8rem; line-height:1.5; font-style:italic; border-left:2px solid var(--accent); padding-left:0.6rem;">
                        {{ ai_output.get('holistic_view') }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ‚ú® AI Recommended Furniture Section -->
        {% if ai_output.get('detailed_placements') %}
        <div class="sidebar-section" style="background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(6,182,212,0.1));
            border:1px solid rgba(124,58,237,0.25);border-radius:12px;padding:1.2rem;">
            <h3 style="margin-bottom:1rem;font-size:1.05rem;display:flex;align-items:center;gap:0.6rem;">
                <span style="font-size:1.4rem;">üß≠</span>
                <span style="background:linear-gradient(90deg,var(--accent-light),var(--highlight)); -webkit-background-clip:text; background-clip:text;
                    -webkit-text-fill-color:transparent;font-weight:700;letter-spacing:0.02em;">PLACEMENT ADVICE</span>
            </h3>

            <div style="display:flex;flex-direction:column;gap:1rem;">
                {% for advice in ai_output.get('detailed_placements', []) %}
                <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:0.9rem;border-radius:10px;
                    transition:all 0.3s ease;position:relative;overflow:hidden;"
                    onmouseover="this.style.background='rgba(255,255,255,0.06)';this.style.borderColor='rgba(124,58,237,0.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.03)';this.style.borderColor='rgba(255,255,255,0.06)'">

                    <div style="display:flex; align-items:center; gap:0.6rem; margin-bottom:0.8rem;">
                        <div style="font-weight:800;color:var(--highlight);font-size:1.05rem;letter-spacing:0.01em;">
                            {{ advice.item | title }}
                        </div>
                        <div
                            style="margin-left:auto; display:flex; align-items:center; gap:0.4rem; background:rgba(255,255,255,0.05); padding:3px 10px; border-radius:30px; border:1px solid rgba(255,255,255,0.1);">
                            <span
                                style="width:12px; height:12px; border-radius:50%; background:{{ advice.get('color', '#8b5cf6') }}; box-shadow:0 0 8px {{ advice.get('color', '#8b5cf6') }};"></span>
                            <span
                                style="font-family:monospace; font-size:0.75rem; color:var(--highlight); font-weight:700;">{{
                                advice.get('color', '#8b5cf6') | upper }}</span>
                        </div>
                    </div>

                    <div style="font-size:0.85rem;color:var(--text-primary);margin-bottom:0.8rem;line-height:1.4;">
                        <div
                            style="color:var(--highlight);font-weight:800;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.06em;display:flex;align-items:center;gap:0.3rem;margin-bottom:0.3rem;opacity:0.8;">
                            üìç Placement Strategy
                        </div>
                        <div
                            style="background:linear-gradient(90deg, rgba(6,182,212,0.15), rgba(124,58,237,0.1)); padding:0.6rem; border-radius:8px; border:1px solid rgba(6,182,212,0.25); font-weight:700; color:var(--text-primary); text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                            {{ advice.where }}
                        </div>
                    </div>

                    {% if advice.get('color_logic') %}
                    <div
                        style="font-size:0.75rem; color:var(--accent-light); margin-bottom:0.8rem; padding:0.6rem; background:rgba(124,58,237,0.08); border-radius:8px; border-left:3px solid var(--accent); font-style:italic; line-height:1.4;">
                        üé® <b>Color Logic:</b> {{ advice.color_logic }}
                    </div>
                    {% endif %}

                    {% if advice.get('description') %}
                    <div
                        style="font-size:0.8rem;color:var(--text-muted);line-height:1.5;margin-bottom:0.8rem;padding:0.6rem;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.05);">
                        {{ advice.description }}
                    </div>
                    {% endif %}

                    <div
                        style="font-size:0.75rem;color:var(--text-muted);display:flex;gap:0.4rem;align-items:flex-start;">
                        <span style="font-size:0.9rem;">üí°</span>
                        <span style="margin-top:0.1rem; line-height:1.3;"><b>Reason:</b> {{ advice.why }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if ai_output.get('color_scheme') %}
            <div style="margin-top:1.4rem;padding-top:1.2rem;border-top:1px solid rgba(255,255,255,0.08);">
                <div
                    style="font-size:0.75rem;color:var(--highlight);display:block;margin-bottom:0.8rem;text-transform:uppercase;letter-spacing:0.08em;font-weight:800;display:flex;align-items:center;gap:0.4rem;">
                    üé® Color Pattern Analysis
                </div>

                {% if ai_output.get('color_palette_explanation') %}
                <div
                    style="font-size:0.75rem; color:var(--text-muted); line-height:1.5; margin-bottom:1rem; font-style:italic;">
                    {{ ai_output.color_palette_explanation }}
                </div>
                {% endif %}

                <div
                    style="display:flex;gap:0.7rem;align-items:center;justify-content:center;background:rgba(0,0,0,0.2);padding:0.8rem;border-radius:12px;">
                    {% for clr in ai_output.get('color_scheme', [])[:5] %}
                    <div style="text-align:center;">
                        <span style="width:34px;height:34px;border-radius:50%;background:{{ clr }};display:block;
                            border:2px solid rgba(255,255,255,0.25);box-shadow:0 0 10px {{ clr }}44;
                            cursor:pointer;transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);"
                            onmouseover="this.style.transform='scale(1.2) translateY(-4px)';this.style.boxShadow='0 8px 20px {{ clr }}88'"
                            onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 0 10px {{ clr }}44'"
                            title="{{ clr }}"></span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% elif ai_output.get('recommended_furniture') %}
        <div class="sidebar-section" style="background:linear-gradient(135deg,rgba(6,182,212,0.08),rgba(139,92,246,0.08));
            border:1px solid rgba(6,182,212,0.2);border-radius:12px;padding:1rem;">
            <h3 style="margin-bottom:0.8rem;font-size:1rem;display:flex;align-items:center;gap:0.5rem;">
                <span style="font-size:1.3rem;">‚ú®</span>
                <span style="background:linear-gradient(90deg,#06b6d4,#8b5cf6);-webkit-background-clip:text;
                    -webkit-text-fill-color:transparent;font-weight:700;">AI RECOMMENDED</span>
            </h3>
            <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.8rem;">
                {% for item in ai_output.get('recommended_furniture', []) %}
                <span style="background:linear-gradient(135deg,rgba(6,182,212,0.2),rgba(139,92,246,0.15));
                    color:#67e8f9;padding:0.4rem 0.9rem;border-radius:25px;font-size:0.85rem;font-weight:500;
                    border:1px solid rgba(6,182,212,0.35);cursor:pointer;transition:all 0.2s ease;
                    box-shadow:0 0 8px rgba(6,182,212,0.1);"
                    onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 0 16px rgba(6,182,212,0.3)'"
                    onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 0 8px rgba(6,182,212,0.1)'">
                    {{ item | replace('_', ' ') | title }}
                </span>
                {% endfor %}
            </div>
            {% if ai_output.get('color_scheme') %}
            <div style="margin-top:0.6rem;padding-top:0.6rem;border-top:1px solid rgba(255,255,255,0.08);">
                <span style="font-size:0.8rem;color:var(--text-muted);display:block;margin-bottom:0.5rem;">
                    üé® Suggested Color Palette
                </span>
                <div style="display:flex;gap:0.5rem;align-items:center;">
                    {% for clr in ai_output.get('color_scheme', [])[:5] %}
                    <div style="text-align:center;">
                        <span style="width:32px;height:32px;border-radius:50%;background:{{ clr }};display:block;
                            border:2px solid rgba(255,255,255,0.2);box-shadow:0 2px 8px rgba(0,0,0,0.3);
                            cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'"
                            onmouseout="this.style.transform='scale(1)'" title="{{ clr }}"></span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- üõí Amazon Product Recommendations -->
        <div class="sidebar-section" id="productRecsSection" style="display:none;">
            <h3 style="display:flex;align-items:center;gap:0.5rem;">
                <span style="font-size:1.2rem;">üõí</span>
                <span style="background:linear-gradient(90deg,#ff9900,#ffcc00);-webkit-background-clip:text;background-clip:text;
                    -webkit-text-fill-color:transparent;font-weight:800;letter-spacing:0.02em;">SHOP ON AMAZON</span>
                <span
                    style="margin-left:auto;font-size:0.65rem;color:#666;font-weight:400;text-transform:none;letter-spacing:0;">via
                    Tavily AI</span>
            </h3>
            <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.8rem;">
                Real products matching your AI recommendations
            </p>
            <div id="productRecsList" style="display:flex;flex-direction:column;gap:0.8rem;max-height:500px;overflow-y:auto;
                scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.08) transparent;">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Recommended Furniture -->
        <div class="sidebar-section">
            <h3>ü™ë Add Furniture</h3>
            <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.8rem;">
                Click to add to the scene
            </p>
            <div class="furniture-list" id="furnitureList">
                <!-- Populated by JavaScript -->
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Selected Object Controls -->
        <div class="sidebar-section">
            <h3>üéõÔ∏è Object Controls</h3>
            <div class="selected-info" id="selectedInfo">
                <h4 id="selectedName">No object selected</h4>
                <p class="text-muted" style="font-size:0.8rem;" id="selectedPos"></p>
            </div>
            <!-- Hint shown when user clicks a button without selection -->
            <div id="selectHint" style="display:none;color:#ef4444;font-size:0.78rem;padding:0.3rem 0.5rem;
                background:rgba(239,68,68,0.1);border-radius:8px;margin-bottom:0.5rem;text-align:center;">
                ‚¨ÜÔ∏è Select a furniture object first
            </div>
            <div class="studio-controls mt-1">
                <button class="btn btn-secondary btn-sm" id="btnRotateLeft" title="Rotate Left">‚Ü∫
                    Rot</button>
                <button class="btn btn-secondary btn-sm" id="btnRotateRight" title="Rotate Right">‚Üª
                    Rot</button>
                <button class="btn btn-secondary btn-sm" id="btnScaleUp" title="Scale Up">+ Size</button>
                <button class="btn btn-secondary btn-sm" id="btnScaleDown" title="Scale Down">‚àí
                    Size</button>
            </div>
            <div class="studio-controls mt-1">
                <button class="btn btn-danger btn-sm" id="btnDelete" title="Delete Selected">üóëÔ∏è
                    Delete</button>
                <button class="btn btn-secondary btn-sm" id="btnReset" title="Reset Scene">üîÑ Reset</button>
            </div>
        </div>

        <!-- Save Button -->
        <div class="sidebar-section">
            <button class="btn btn-primary w-full" id="btnSave">
                üíæ Save Design
            </button>
            <a href="{{ url_for('designs.dashboard') }}" class="btn btn-secondary w-full mt-1"
                style="text-align:center;">
                ‚Üê Back to Dashboard
            </a>
        </div>
    </aside>

    <!-- ============ 3D Canvas ============ -->
    <div class="studio-canvas-wrapper" id="canvasWrapper">
        <canvas id="studio-canvas"></canvas>

        <!-- Face count badge -->
        {% if face_urls %}
        <div style="position:absolute;top:12px;left:12px;background:rgba(0,0,0,0.65);color:#06b6d4;
            font-size:0.78rem;padding:4px 12px;border-radius:20px;pointer-events:none;">
            üè† {{ face_urls|length }} face{{ 's' if face_urls|length != 1 else '' }} loaded
        </div>
        {% endif %}

        <!-- Toolbar overlay -->
        <div class="studio-toolbar" id="studioToolbar">
            <button class="btn btn-secondary btn-sm" id="btnToggleBg" title="Toggle Background">üñºÔ∏è</button>
            <button class="btn btn-secondary btn-sm" id="btnResetCamera" title="Reset Camera">üé•</button>
            <button class="btn btn-secondary btn-sm" id="btnGrid" title="Toggle Grid">üìê</button>
        </div>

    </div>
</div>

<!-- ============ Voice Assistant Widget ============ -->
<div class="voice-assistant" id="voiceAssistant">
    <div class="voice-panel glass-card" id="voicePanel">
        <div class="panel-header">
            <h3>üéôÔ∏è Design Assistant</h3>
            <button class="btn btn-secondary btn-sm" id="closeVoicePanel" style="padding:0.2rem 0.5rem;">‚úï</button>
        </div>
        <div class="voice-messages" id="voiceMessages">
            <div class="voice-message bot-msg">
                Hi! I'm your AI design assistant. Ask me about colors, furniture placement, or style tips! üé®
            </div>
        </div>
        <div class="voice-input">
            <input type="text" id="voiceInput" placeholder="Ask about design..." autocomplete="off">
            <button class="btn btn-primary btn-sm" id="voiceSend">Send</button>
        </div>
    </div>
    <button class="voice-btn" id="voiceToggle" title="Design Assistant">üéôÔ∏è</button>
</div>
{% endblock %}

{% block footer %}{% endblock %}

{% block extra_scripts %}
<!-- Studio data injected directly into JS to avoid HTML-encoding issues -->
<script id="studioJSON" type="application/json">
{
    "designId": {{ design.id }},
    "faceUrls": {{ face_urls | tojson }},
    "roomType": {{ design.room_type | tojson }},
    "style": {{ design.style | tojson }},
    "aiOutput": {{ ai_output | tojson }},
    "placements": {{ placements | tojson }},
    "csrfToken": {{ csrf_token() | tojson }}
}
</script>
<script>
    try {
        window.STUDIO_DATA = JSON.parse(document.getElementById('studioJSON').textContent);
    } catch (e) {
        console.error('[Studio] Failed to parse STUDIO_DATA JSON:', e);
        window.STUDIO_DATA = { designId: 0, faceUrls: {}, roomType: 'living_room', style: 'modern', aiOutput: {}, placements: [], csrfToken: '' };
    }
    console.log('[Studio] faceUrls:', JSON.stringify(window.STUDIO_DATA.faceUrls));
</script>
<script type="module" src="{{ url_for('static', filename='js/studio.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}